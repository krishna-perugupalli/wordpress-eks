name: Terraform Documentation

on:
  push:
    branches:
      - loki-tempo
    paths:
      - 'modules/**/*.tf'
      - '.github/workflows/terraform-docs.yml'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: terraform-docs-${{ github.ref }}
  cancel-in-progress: true

env:
  TERRAFORM_DOCS_VERSION: "v0.18.0"

jobs:
  generate-and-commit-docs:
    name: Generate and Commit Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup terraform-docs
        run: |
          # Download and install terraform-docs
          curl -sSLo terraform-docs.tar.gz \
            "https://github.com/terraform-docs/terraform-docs/releases/download/${{ env.TERRAFORM_DOCS_VERSION }}/terraform-docs-${{ env.TERRAFORM_DOCS_VERSION }}-linux-amd64.tar.gz"
          tar -xzf terraform-docs.tar.gz
          chmod +x terraform-docs
          sudo mv terraform-docs /usr/local/bin/
          terraform-docs --version

      - name: Discover and generate documentation for all modules
        id: generate-all
        run: |
          # Find all module directories
          module_dirs=$(find modules -mindepth 1 -maxdepth 1 -type d | sort)
          module_count=$(echo "$module_dirs" | wc -l)
          
          echo "ðŸ“¦ Found ${module_count} modules"
          echo "$module_dirs"
          
          updated_count=0
          failed_count=0
          skipped_count=0
          updated_modules=""
          failed_modules=""
          
          # Process each module
          for module_dir in $module_dirs; do
            echo ""
            echo "=================================================="
            echo "ðŸ“ Processing: ${module_dir}"
            echo "=================================================="
            
            # Check if module has required files
            if [ ! -f "${module_dir}/variables.tf" ] && [ ! -f "${module_dir}/outputs.tf" ]; then
              echo "â­ï¸  Skipping ${module_dir} - no variables.tf or outputs.tf"
              skipped_count=$((skipped_count + 1))
              continue
            fi
            
            # Generate documentation
            cd "${module_dir}"
            if terraform-docs markdown table \
              --output-file README.md \
              --output-mode inject \
              --sort-by required \
              --header-from main.tf \
              .; then
              
              # Check if README was modified
              if ! git diff --quiet README.md; then
                echo "âœ… Documentation updated for ${module_dir}"
                updated_count=$((updated_count + 1))
                updated_modules="${updated_modules}${module_dir}\n"
              else
                echo "â„¹ï¸  No changes for ${module_dir}"
              fi
            else
              echo "âŒ Failed to generate documentation for ${module_dir}"
              failed_count=$((failed_count + 1))
              failed_modules="${failed_modules}${module_dir}\n"
            fi
            
            cd - > /dev/null
          done
          
          echo ""
          echo "=================================================="
          echo "ðŸ“Š Summary"
          echo "=================================================="
          echo "Total modules: ${module_count}"
          echo "Updated: ${updated_count}"
          echo "Failed: ${failed_count}"
          echo "Skipped: ${skipped_count}"
          
          # Save outputs
          echo "updated_count=${updated_count}" >> $GITHUB_OUTPUT
          echo "failed_count=${failed_count}" >> $GITHUB_OUTPUT
          echo "skipped_count=${skipped_count}" >> $GITHUB_OUTPUT
          echo "total_count=${module_count}" >> $GITHUB_OUTPUT
          
          if [ ${failed_count} -gt 0 ]; then
            echo "has_failures=true" >> $GITHUB_OUTPUT
            echo "failed_modules<<EOF" >> $GITHUB_OUTPUT
            echo -e "${failed_modules}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "has_failures=false" >> $GITHUB_OUTPUT
          fi
          
          if [ ${updated_count} -gt 0 ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "updated_modules<<EOF" >> $GITHUB_OUTPUT
            echo -e "${updated_modules}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push documentation changes
        if: steps.generate-all.outputs.has_updates == 'true'
        run: |
          # Configure git
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Show what changed
          echo "ðŸ“‹ Changed files:"
          git status --short
          
          # Stage all README changes
          git add modules/*/README.md
          
          # Show what will be committed
          echo ""
          echo "ðŸ“ Files to be committed:"
          git diff --cached --name-only
          
          # Commit all changes in one commit
          cat > /tmp/commit-msg.txt <<'EOF'
          docs: update terraform-docs for ${{ steps.generate-all.outputs.updated_count }} module(s)
          
          Updated modules:
          ${{ steps.generate-all.outputs.updated_modules }}
          
          Generated by terraform-docs workflow
          EOF
          
          git commit -F /tmp/commit-msg.txt
          
          # Push changes
          echo ""
          echo "ðŸ“¤ Pushing changes to ${{ github.ref_name }}..."
          git push origin HEAD:${{ github.ref_name }}
          
          echo "âœ… Successfully pushed documentation updates"

      - name: Create summary
        if: always()
        run: |
          updated_count="${{ steps.generate-all.outputs.updated_count }}"
          failed_count="${{ steps.generate-all.outputs.failed_count }}"
          skipped_count="${{ steps.generate-all.outputs.skipped_count }}"
          total_count="${{ steps.generate-all.outputs.total_count }}"
          has_failures="${{ steps.generate-all.outputs.has_failures }}"
          has_updates="${{ steps.generate-all.outputs.has_updates }}"
          
          echo "## ðŸ“š Terraform Documentation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total Modules | ${total_count} |" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… Updated | ${updated_count} |" >> $GITHUB_STEP_SUMMARY
          echo "| âŒ Failed | ${failed_count} |" >> $GITHUB_STEP_SUMMARY
          echo "| â­ï¸ Skipped | ${skipped_count} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${has_updates}" = "true" ]; then
            echo "### âœ… Updated Modules" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.generate-all.outputs.updated_modules }}" | while read -r module; do
              [ -n "$module" ] && echo "- \`${module}\`" >> $GITHUB_STEP_SUMMARY
            done
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${has_failures}" = "true" ]; then
            echo "### âŒ Failed Modules" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.generate-all.outputs.failed_modules }}" | while read -r module; do
              [ -n "$module" ] && echo "- \`${module}\`" >> $GITHUB_STEP_SUMMARY
            done
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${has_updates}" = "false" ] && [ "${has_failures}" = "false" ]; then
            echo "âœ… All module documentation is up to date!" >> $GITHUB_STEP_SUMMARY
          elif [ "${has_failures}" = "true" ]; then
            echo "âš ï¸ Some modules failed documentation generation. Please review the logs above." >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Documentation successfully updated and committed!" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check for failures
        if: steps.generate-all.outputs.has_failures == 'true'
        run: |
          echo "::warning::Some modules failed documentation generation"
          echo "Failed modules:"
          echo "${{ steps.generate-all.outputs.failed_modules }}"
          # Don't fail the workflow, just warn
          exit 0
