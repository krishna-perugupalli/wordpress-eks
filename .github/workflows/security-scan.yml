name: Security Scanning

on:
  push:
    branches:
      - main
      - master
      # - feat-*
    paths:
      - '**/*.tf'
      - '**/*.tfvars'
      - '.github/workflows/security-scan.yml'
      - '.checkov.yml'
  pull_request:
    paths:
      - '**/*.tf'
      - '**/*.tfvars'
      - '.github/workflows/security-scan.yml'
      - '.checkov.yml'
  #schedule:
    # Run daily at 2 AM UTC
  #  - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  security-events: write

concurrency:
  group: security-${{ github.ref }}
  cancel-in-progress: true

env:
  CHECKOV_VERSION: "3.2.0"

jobs:
  checkov-scan:
    name: Checkov Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache Checkov
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-checkov-${{ env.CHECKOV_VERSION }}
          restore-keys: |
            ${{ runner.os }}-pip-checkov-

      - name: Install Checkov
        run: |
          pip install checkov==${{ env.CHECKOV_VERSION }}
          checkov --version

      - name: Run Checkov scan
        id: checkov
        run: |
          # Create output directory
          mkdir -p checkov-results
          
          # Run Checkov with multiple output formats
          # Exit code 0: No issues found
          # Exit code 1: Issues found
          # Exit code 2: Scan error
          set +e
          checkov \
            --directory . \
            --framework terraform \
            --output cli \
            --output json \
            --output sarif \
            --output-file-path checkov-results \
            --download-external-modules true \
            --compact \
            --quiet \
            --soft-fail
          
          checkov_exit_code=$?
          echo "checkov_exit_code=${checkov_exit_code}" >> $GITHUB_OUTPUT
          
          # Load custom severity mapping and apply to results
          severity_map_file=".github/workflows/checkov-severity-mapping.json"
          
          if [ -f "checkov-results/results_json.json" ] && [ -f "$severity_map_file" ]; then
            echo "ðŸ“‹ Applying custom severity mapping..."
            
            # Extract severity lists from mapping file
            critical_checks=$(jq -r '.severity_mapping.CRITICAL[]' "$severity_map_file" | tr '\n' '|' | sed 's/|$//')
            high_checks=$(jq -r '.severity_mapping.HIGH[]' "$severity_map_file" | tr '\n' '|' | sed 's/|$//')
            medium_checks=$(jq -r '.severity_mapping.MEDIUM[]' "$severity_map_file" | tr '\n' '|' | sed 's/|$//')
            low_checks=$(jq -r '.severity_mapping.LOW[]' "$severity_map_file" | tr '\n' '|' | sed 's/|$//')
            
            # Count findings by custom severity mapping
            critical_count=$(jq --arg checks "$critical_checks" '[.results.failed_checks[] | select(.check_id | test($checks))] | length' checkov-results/results_json.json 2>/dev/null || echo "0")
            high_count=$(jq --arg checks "$high_checks" '[.results.failed_checks[] | select(.check_id | test($checks))] | length' checkov-results/results_json.json 2>/dev/null || echo "0")
            medium_count=$(jq --arg checks "$medium_checks" '[.results.failed_checks[] | select(.check_id | test($checks))] | length' checkov-results/results_json.json 2>/dev/null || echo "0")
            low_count=$(jq --arg checks "$low_checks" '[.results.failed_checks[] | select(.check_id | test($checks))] | length' checkov-results/results_json.json 2>/dev/null || echo "0")
            
            # Get total failed checks
            total_failed=$(jq '.results.failed_checks | length' checkov-results/results_json.json 2>/dev/null || echo "0")
            
            # Calculate unmapped checks (not in our severity mapping)
            mapped_count=$((critical_count + high_count + medium_count + low_count))
            unmapped_count=$((total_failed - mapped_count))
            
            # Treat unmapped checks as MEDIUM by default
            if [ "$unmapped_count" -gt 0 ]; then
              echo "::warning::Found ${unmapped_count} checks not in severity mapping, treating as MEDIUM"
              medium_count=$((medium_count + unmapped_count))
            fi
            
            null_severity_count=0
            
            echo "critical_count=${critical_count}" >> $GITHUB_OUTPUT
            echo "high_count=${high_count}" >> $GITHUB_OUTPUT
            echo "medium_count=${medium_count}" >> $GITHUB_OUTPUT
            echo "low_count=${low_count}" >> $GITHUB_OUTPUT
            echo "null_severity_count=${null_severity_count}" >> $GITHUB_OUTPUT
            
            total_issues=${total_failed}
            echo "total_issues=${total_issues}" >> $GITHUB_OUTPUT
            
            passed_count=$(jq '.summary.passed // 0' checkov-results/results_json.json 2>/dev/null || echo "0")
            echo "passed_count=${passed_count}" >> $GITHUB_OUTPUT
            
            echo "ðŸ“Š Security Scan Summary (Custom Severity Mapping):"
            echo "  âœ… Passed: ${passed_count}"
            echo "  ðŸ”´ Critical: ${critical_count}"
            echo "  ðŸŸ  High: ${high_count}"
            echo "  ðŸŸ¡ Medium: ${medium_count}"
            echo "  ðŸ”µ Low: ${low_count}"
            echo "  ðŸ“‹ Total Failed: ${total_issues}"
          else
            echo "critical_count=0" >> $GITHUB_OUTPUT
            echo "high_count=0" >> $GITHUB_OUTPUT
            echo "medium_count=0" >> $GITHUB_OUTPUT
            echo "low_count=0" >> $GITHUB_OUTPUT
            echo "null_severity_count=0" >> $GITHUB_OUTPUT
            echo "total_issues=0" >> $GITHUB_OUTPUT
            echo "passed_count=0" >> $GITHUB_OUTPUT
          fi
          
          # Exit with original Checkov exit code
          exit ${checkov_exit_code}

      - name: Upload SARIF results to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: checkov-results/results_sarif.sarif
          category: checkov

      - name: Upload Checkov results as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: checkov-results
          path: checkov-results/
          retention-days: 30

      - name: Evaluate failure thresholds
        id: evaluate
        if: always()
        run: |
          critical_count=${{ steps.checkov.outputs.critical_count }}
          high_count=${{ steps.checkov.outputs.high_count }}
          medium_count=${{ steps.checkov.outputs.medium_count }}
          low_count=${{ steps.checkov.outputs.low_count }}
          total_issues=${{ steps.checkov.outputs.total_issues }}
          
          echo "Evaluating failure thresholds (Custom Severity Mapping)..."
          echo "Critical issues: ${critical_count}"
          echo "High severity issues: ${high_count}"
          echo "Medium severity issues: ${medium_count}"
          echo "Low severity issues: ${low_count}"
          echo "Total failed checks: ${total_issues}"
          
          # Fail on CRITICAL or HIGH severity issues (based on custom mapping)
          if [ "${critical_count}" -gt 0 ] || [ "${high_count}" -gt 0 ]; then
            echo "should_fail=true" >> $GITHUB_OUTPUT
            echo "::error::Security scan failed: Found ${critical_count} critical and ${high_count} high severity issues"
            exit 1
          else
            echo "should_fail=false" >> $GITHUB_OUTPUT
            if [ "${total_issues}" -gt 0 ]; then
              echo "::warning::Found ${total_issues} failed security checks (${medium_count} medium, ${low_count} low severity)"
              echo "âš ï¸  Security scan passed with warnings: No critical/high severity issues"
            else
              echo "âœ… No security issues found"
            fi
          fi

      - name: Generate detailed findings report
        if: always() && steps.checkov.outputs.total_issues != '0'
        id: report
        run: |
          # Extract detailed findings from JSON
          if [ -f "checkov-results/results_json.json" ]; then
            echo "Generating detailed findings report..."
            
            # Create markdown report
            cat > findings_report.md <<'EOF'
          ## ðŸ” Security Findings Details
          
          EOF
            
            # Add critical findings
            critical_count=${{ steps.checkov.outputs.critical_count }}
            if [ "${critical_count}" -gt 0 ]; then
              echo "### ðŸ”´ Critical Severity Issues (${critical_count})" >> findings_report.md
              echo "" >> findings_report.md
              jq -r '.results.failed_checks[] | select(.severity == "CRITICAL") | "- **\(.check_id)**: \(.check_name)\n  - File: `\(.file_path)`\n  - Line: \(.file_line_range[0])-\(.file_line_range[1])\n  - Resource: \(.resource)\n  - [More Info](\(.guideline))\n"' checkov-results/results_json.json >> findings_report.md
              echo "" >> findings_report.md
            fi
            
            # Add high findings
            high_count=${{ steps.checkov.outputs.high_count }}
            if [ "${high_count}" -gt 0 ]; then
              echo "### ðŸŸ  High Severity Issues (${high_count})" >> findings_report.md
              echo "" >> findings_report.md
              jq -r '.results.failed_checks[] | select(.severity == "HIGH") | "- **\(.check_id)**: \(.check_name)\n  - File: `\(.file_path)`\n  - Line: \(.file_line_range[0])-\(.file_line_range[1])\n  - Resource: \(.resource)\n  - [More Info](\(.guideline))\n"' checkov-results/results_json.json >> findings_report.md
              echo "" >> findings_report.md
            fi
            
            # Add medium findings (limited to first 10)
            medium_count=${{ steps.checkov.outputs.medium_count }}
            if [ "${medium_count}" -gt 0 ]; then
              echo "### ðŸŸ¡ Medium Severity Issues (${medium_count})" >> findings_report.md
              echo "" >> findings_report.md
              if [ "${medium_count}" -gt 10 ]; then
                echo "_Showing first 10 of ${medium_count} medium severity issues. See full report in artifacts._" >> findings_report.md
                echo "" >> findings_report.md
              fi
              jq -r '.results.failed_checks[] | select(.severity == "MEDIUM") | "- **\(.check_id)**: \(.check_name)\n  - File: `\(.file_path)`\n  - Resource: \(.resource)\n"' checkov-results/results_json.json | head -n 50 >> findings_report.md
              echo "" >> findings_report.md
            fi
            
            # Add unrated findings (limited to first 15)
            null_severity_count=${{ steps.checkov.outputs.null_severity_count }}
            if [ "${null_severity_count}" -gt 0 ]; then
              echo "### âšª Unrated Severity Issues (${null_severity_count})" >> findings_report.md
              echo "" >> findings_report.md
              echo "_These checks don't have explicit severity ratings in Checkov. Review and address as appropriate._" >> findings_report.md
              echo "" >> findings_report.md
              if [ "${null_severity_count}" -gt 15 ]; then
                echo "_Showing first 15 of ${null_severity_count} unrated issues. Download the full report from artifacts._" >> findings_report.md
                echo "" >> findings_report.md
              fi
              jq -r '.results.failed_checks[] | select(.severity == null or .severity == "UNKNOWN" or .severity == "") | "- **\(.check_id)**: \(.check_name)\n  - File: `\(.file_path)`\n  - Resource: \(.resource)\n"' checkov-results/results_json.json | head -n 75 >> findings_report.md
              echo "" >> findings_report.md
            fi
            
            echo "report_generated=true" >> $GITHUB_OUTPUT
          else
            echo "report_generated=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR with security findings
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const criticalCount = '${{ steps.checkov.outputs.critical_count }}';
            const highCount = '${{ steps.checkov.outputs.high_count }}';
            const mediumCount = '${{ steps.checkov.outputs.medium_count }}';
            const lowCount = '${{ steps.checkov.outputs.low_count }}';
            const totalIssues = '${{ steps.checkov.outputs.total_issues }}';
            const passedCount = '${{ steps.checkov.outputs.passed_count }}';
            const shouldFail = '${{ steps.evaluate.outputs.should_fail }}';
            
            let body = '';
            
            if (totalIssues === '0') {
              body = `## âœ… Security Scan Passed
            
            No security issues detected by Checkov.
            
            **Passed Checks:** ${passedCount}
            
            All Terraform configurations meet security best practices.`;
            } else {
              const status = shouldFail === 'true' ? 'âŒ' : 'âš ï¸';
              const statusText = shouldFail === 'true' ? 'Failed' : 'Passed with Warnings';
              
              body = `## ${status} Security Scan ${statusText}
            
            ### ðŸ“Š Summary (Custom Severity Mapping)
            
            | Severity | Count |
            |----------|-------|
            | âœ… Passed | ${passedCount} |
            | ðŸ”´ Critical | ${criticalCount} |
            | ðŸŸ  High | ${highCount} |
            | ðŸŸ¡ Medium | ${mediumCount} |
            | ðŸ”µ Low | ${lowCount} |
            | **Total Failed** | **${totalIssues}** |
            
            > **Note:** Severity levels are assigned using a custom mapping tailored for this WordPress on EKS infrastructure. Only CRITICAL and HIGH severity issues block PR merging.
            
            `;
              
              if (shouldFail === 'true') {
                body += `### â›” Action Required
            
            This PR cannot be merged due to **${criticalCount} critical** and **${highCount} high** severity security issues.
            
            Please review and fix the security misconfigurations before merging.
            
            `;
              }
              
              // Add detailed findings if report was generated
              if ('${{ steps.report.outputs.report_generated }}' === 'true' && fs.existsSync('findings_report.md')) {
                const detailedReport = fs.readFileSync('findings_report.md', 'utf8');
                body += detailedReport;
              }
              
              body += `
            ### ðŸ“‹ Full Report
            
            - View detailed findings in the [Security tab](https://github.com/${{ github.repository }}/security/code-scanning)
            - Download the [Checkov results artifact](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ### ðŸ”§ Remediation
            
            1. Review the security findings above
            2. Update your Terraform configurations to address the issues
            3. Re-run the security scan to verify fixes
            4. If you believe a finding is a false positive, add it to \`.checkov.yml\` skip list
            
            **Need help?** Check the [Checkov documentation](https://www.checkov.io/5.Policy%20Index/terraform.html) for remediation guidance.`;
            }
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Security Scan')
            );
            
            // Update or create comment
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [checkov-scan]
    if: always()
    steps:
      - name: Check security scan results
        run: |
          scan_result="${{ needs.checkov-scan.result }}"
          
          echo "## Security Scan Results"
          echo "- Checkov Scan: ${scan_result}"
          
          if [[ "$scan_result" != "success" ]]; then
            echo "::error::Security scan failed or was cancelled"
            exit 1
          fi
          
          echo "âœ… Security scan completed successfully!"
