name: Security Scanning

on:
  push:
    branches:
      - main
      - master
    paths:
      - '**/*.tf'
      - '**/*.tfvars'
      - '.github/workflows/security-scan.yml'
      - '.checkov.yml'
  pull_request:
    paths:
      - '**/*.tf'
      - '**/*.tfvars'
      - '.github/workflows/security-scan.yml'
      - '.checkov.yml'
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  security-events: write

concurrency:
  group: security-${{ github.ref }}
  cancel-in-progress: true

env:
  CHECKOV_VERSION: "3.2.0"

jobs:
  checkov-scan:
    name: Checkov Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache Checkov
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-checkov-${{ env.CHECKOV_VERSION }}
          restore-keys: |
            ${{ runner.os }}-pip-checkov-

      - name: Install Checkov
        run: |
          pip install checkov==${{ env.CHECKOV_VERSION }}
          checkov --version

      - name: Run Checkov scan
        id: checkov
        run: |
          # Create output directory
          mkdir -p checkov-results
          
          # Run Checkov with multiple output formats
          # Exit code 0: No issues found
          # Exit code 1: Issues found
          # Exit code 2: Scan error
          set +e
          checkov \
            --directory . \
            --framework terraform \
            --output cli \
            --output sarif \
            --output-file-path checkov-results \
            --download-external-modules true \
            --compact \
            --quiet \
            --soft-fail
          
          checkov_exit_code=$?
          echo "checkov_exit_code=${checkov_exit_code}" >> $GITHUB_OUTPUT
          
          # Parse results for summary
          if [ -f "checkov-results/results_sarif.sarif" ]; then
            # Count findings by severity
            critical_count=$(jq '[.runs[].results[] | select(.level == "error" and (.properties.severity // "MEDIUM") == "CRITICAL")] | length' checkov-results/results_sarif.sarif)
            high_count=$(jq '[.runs[].results[] | select(.level == "error" and (.properties.severity // "MEDIUM") == "HIGH")] | length' checkov-results/results_sarif.sarif)
            medium_count=$(jq '[.runs[].results[] | select(.level == "warning" and (.properties.severity // "MEDIUM") == "MEDIUM")] | length' checkov-results/results_sarif.sarif)
            low_count=$(jq '[.runs[].results[] | select(.level == "note" and (.properties.severity // "LOW") == "LOW")] | length' checkov-results/results_sarif.sarif)
            info_count=$(jq '[.runs[].results[] | select(.level == "note" and (.properties.severity // "INFO") == "INFO")] | length' checkov-results/results_sarif.sarif)
            
            echo "critical_count=${critical_count}" >> $GITHUB_OUTPUT
            echo "high_count=${high_count}" >> $GITHUB_OUTPUT
            echo "medium_count=${medium_count}" >> $GITHUB_OUTPUT
            echo "low_count=${low_count}" >> $GITHUB_OUTPUT
            echo "info_count=${info_count}" >> $GITHUB_OUTPUT
            
            total_issues=$((critical_count + high_count + medium_count + low_count + info_count))
            echo "total_issues=${total_issues}" >> $GITHUB_OUTPUT
            
            echo "ðŸ“Š Security Scan Summary:"
            echo "  ðŸ”´ Critical: ${critical_count}"
            echo "  ðŸŸ  High: ${high_count}"
            echo "  ðŸŸ¡ Medium: ${medium_count}"
            echo "  ðŸ”µ Low: ${low_count}"
            echo "  âšª Info: ${info_count}"
            echo "  ðŸ“‹ Total: ${total_issues}"
          else
            echo "critical_count=0" >> $GITHUB_OUTPUT
            echo "high_count=0" >> $GITHUB_OUTPUT
            echo "medium_count=0" >> $GITHUB_OUTPUT
            echo "low_count=0" >> $GITHUB_OUTPUT
            echo "info_count=0" >> $GITHUB_OUTPUT
            echo "total_issues=0" >> $GITHUB_OUTPUT
          fi
          
          # Exit with original Checkov exit code
          exit ${checkov_exit_code}

      - name: Upload SARIF results to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: checkov-results/results_sarif.sarif
          category: checkov

      - name: Upload Checkov results as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: checkov-results
          path: checkov-results/
          retention-days: 30

      - name: Evaluate failure thresholds
        id: evaluate
        if: always()
        run: |
          critical_count=${{ steps.checkov.outputs.critical_count }}
          high_count=${{ steps.checkov.outputs.high_count }}
          
          echo "Evaluating failure thresholds..."
          echo "Critical issues: ${critical_count}"
          echo "High severity issues: ${high_count}"
          
          # Fail if any CRITICAL or HIGH severity issues found
          if [ "${critical_count}" -gt 0 ] || [ "${high_count}" -gt 0 ]; then
            echo "should_fail=true" >> $GITHUB_OUTPUT
            echo "::error::Security scan failed: Found ${critical_count} critical and ${high_count} high severity issues"
            exit 1
          else
            echo "should_fail=false" >> $GITHUB_OUTPUT
            echo "âœ… No critical or high severity security issues found"
          fi

      - name: Generate detailed findings report
        if: always() && steps.checkov.outputs.total_issues != '0'
        id: report
        run: |
          # Extract detailed findings from SARIF
          if [ -f "checkov-results/results_sarif.sarif" ]; then
            echo "Generating detailed findings report..."
            
            # Create markdown report
            cat > findings_report.md <<'EOF'
          ## ðŸ” Security Findings Details
          
          EOF
            
            # Add critical findings
            critical_count=${{ steps.checkov.outputs.critical_count }}
            if [ "${critical_count}" -gt 0 ]; then
              echo "### ðŸ”´ Critical Severity Issues (${critical_count})" >> findings_report.md
              echo "" >> findings_report.md
              jq -r '.runs[].results[] | select(.level == "error" and (.properties.severity // "MEDIUM") == "CRITICAL") | "- **\(.ruleId)**: \(.message.text)\n  - File: `\(.locations[0].physicalLocation.artifactLocation.uri)`\n  - Line: \(.locations[0].physicalLocation.region.startLine)\n  - [More Info](\(.helpUri // "N/A"))\n"' checkov-results/results_sarif.sarif >> findings_report.md
              echo "" >> findings_report.md
            fi
            
            # Add high findings
            high_count=${{ steps.checkov.outputs.high_count }}
            if [ "${high_count}" -gt 0 ]; then
              echo "### ðŸŸ  High Severity Issues (${high_count})" >> findings_report.md
              echo "" >> findings_report.md
              jq -r '.runs[].results[] | select(.level == "error" and (.properties.severity // "MEDIUM") == "HIGH") | "- **\(.ruleId)**: \(.message.text)\n  - File: `\(.locations[0].physicalLocation.artifactLocation.uri)`\n  - Line: \(.locations[0].physicalLocation.region.startLine)\n  - [More Info](\(.helpUri // "N/A"))\n"' checkov-results/results_sarif.sarif >> findings_report.md
              echo "" >> findings_report.md
            fi
            
            # Add medium findings (limited to first 10)
            medium_count=${{ steps.checkov.outputs.medium_count }}
            if [ "${medium_count}" -gt 0 ]; then
              echo "### ðŸŸ¡ Medium Severity Issues (${medium_count})" >> findings_report.md
              echo "" >> findings_report.md
              if [ "${medium_count}" -gt 10 ]; then
                echo "_Showing first 10 of ${medium_count} medium severity issues. See full report in Security tab._" >> findings_report.md
                echo "" >> findings_report.md
              fi
              jq -r '.runs[].results[] | select(.level == "warning" and (.properties.severity // "MEDIUM") == "MEDIUM") | "- **\(.ruleId)**: \(.message.text)\n  - File: `\(.locations[0].physicalLocation.artifactLocation.uri)`\n  - Line: \(.locations[0].physicalLocation.region.startLine)\n"' checkov-results/results_sarif.sarif | head -n 40 >> findings_report.md
              echo "" >> findings_report.md
            fi
            
            echo "report_generated=true" >> $GITHUB_OUTPUT
          else
            echo "report_generated=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR with security findings
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const criticalCount = '${{ steps.checkov.outputs.critical_count }}';
            const highCount = '${{ steps.checkov.outputs.high_count }}';
            const mediumCount = '${{ steps.checkov.outputs.medium_count }}';
            const lowCount = '${{ steps.checkov.outputs.low_count }}';
            const infoCount = '${{ steps.checkov.outputs.info_count }}';
            const totalIssues = '${{ steps.checkov.outputs.total_issues }}';
            const shouldFail = '${{ steps.evaluate.outputs.should_fail }}';
            
            let body = '';
            
            if (totalIssues === '0') {
              body = `## âœ… Security Scan Passed
            
            No security issues detected by Checkov.
            
            All Terraform configurations meet security best practices.`;
            } else {
              const status = shouldFail === 'true' ? 'âŒ' : 'âš ï¸';
              const statusText = shouldFail === 'true' ? 'Failed' : 'Passed with Warnings';
              
              body = `## ${status} Security Scan ${statusText}
            
            ### ðŸ“Š Summary
            
            | Severity | Count |
            |----------|-------|
            | ðŸ”´ Critical | ${criticalCount} |
            | ðŸŸ  High | ${highCount} |
            | ðŸŸ¡ Medium | ${mediumCount} |
            | ðŸ”µ Low | ${lowCount} |
            | âšª Info | ${infoCount} |
            | **Total** | **${totalIssues}** |
            
            `;
              
              if (shouldFail === 'true') {
                body += `### â›” Action Required
            
            This PR cannot be merged due to **${criticalCount} critical** and **${highCount} high** severity security issues.
            
            Please review and fix the security misconfigurations before merging.
            
            `;
              }
              
              // Add detailed findings if report was generated
              if ('${{ steps.report.outputs.report_generated }}' === 'true' && fs.existsSync('findings_report.md')) {
                const detailedReport = fs.readFileSync('findings_report.md', 'utf8');
                body += detailedReport;
              }
              
              body += `
            ### ðŸ“‹ Full Report
            
            - View detailed findings in the [Security tab](https://github.com/${{ github.repository }}/security/code-scanning)
            - Download the [Checkov results artifact](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ### ðŸ”§ Remediation
            
            1. Review the security findings above
            2. Update your Terraform configurations to address the issues
            3. Re-run the security scan to verify fixes
            4. If you believe a finding is a false positive, add it to \`.checkov.yml\` skip list
            
            **Need help?** Check the [Checkov documentation](https://www.checkov.io/5.Policy%20Index/terraform.html) for remediation guidance.`;
            }
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Security Scan')
            );
            
            // Update or create comment
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [checkov-scan]
    if: always()
    steps:
      - name: Check security scan results
        run: |
          scan_result="${{ needs.checkov-scan.result }}"
          
          echo "## Security Scan Results"
          echo "- Checkov Scan: ${scan_result}"
          
          if [[ "$scan_result" != "success" ]]; then
            echo "::error::Security scan failed or was cancelled"
            exit 1
          fi
          
          echo "âœ… Security scan completed successfully!"
